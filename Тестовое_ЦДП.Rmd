---
title: "Тестовое задание для ЦДП"
date: "2024-10-25"
author: Жарахович Мария
output:
  html_document:
    toc: true
    toc_depth: 6
    toc_float:
      smooth_scroll: true
    theme: flatly
    highlight: tango
    code_folding: hide
    css: styles.css
  pdf_document:
    toc: true
    toc_depth: '6'
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Анализ структуры доходов граждан в разрезе муниципальных образований в 2018-2023 годах
```{r, include=FALSE, warning=FALSE}
library(openxlsx)
library(dplyr)
library(ggplot2)
library(table1)
library(kableExtra)
library(knitr)
```
### Загрузка данных
#### Задача 1
<b><i>Скачать данные об объеме социальных выплат и налогооблагаемых
денежных доходов в разрезе муниципальных образований и версионный
справочник муниципальных образований от СберИндекс.</i></b>

Загружаем в рабочую среду нашу книгу с данными и версионный справочник. Для наших задач актуальны только последние 6 листов книги (2017-2022), именно их мы и загрузим, объединив в единый датафрейм. Для датафрейма также подпишем нумерацию годов по-другому: с 2018 по 2023 (поскольку росстат публикует данные за предыдущий год). 
```{r, include=FALSE, warning=FALSE}
# файл с данными о доходах и выплатах
file_path <- '/Users/maria/Desktop/работа/задание ЦДП/Urov-14a_2010-2022.xlsx'

data_list <- list()

for (year in 2017:2022) {
  sheet_name <- as.character(year)
  data <- read.xlsx(file_path, sheet = sheet_name)
  data$Year <- year + 1  
  data_list[[sheet_name]] <- data
}

combined_data <- bind_rows(data_list)
combined_data_clean <- na.omit(combined_data)
```

Загружаем версионный справочник (файл "t_dict_municipal_districts").
```{r, include=FALSE, warning=FALSE, comment=NA}
dict_path <- '/Users/maria/Desktop/работа/задание ЦДП/t_dict_municipal_districts.xlsx'
dict_data <- read.xlsx(dict_path)
```

Группируем данные по названию муниципального образования и считаем количество уникальных кодов ОКТМО. Затем оставляем только группы с более чем 1 уникальным кодом ОКТМО. Далее выводим список кодов для каждого муниципалитета, у которого более одного уникального кода. Как видим ниже, таких образований всего 492. 
```{r, comment = NA}
municipalities_with_multiple_oktmo <- dict_data %>%
  group_by(municipal_district_name_short) %>%
  filter(n_distinct(oktmo) > 1) %>%    
  summarize(Коды_ОКТМО = paste(unique(oktmo), collapse = ", ")) %>%   
  arrange(municipal_district_name_short)

first_15_municipalities <- head(municipalities_with_multiple_oktmo, 15)

kable(first_15_municipalities, 
      col.names = c("Муниципальный район", "Коды ОКТМО"),
      caption = paste("Фрагмент таблицы (всего строк: ", nrow(municipalities_with_multiple_oktmo), ")", sep = ""),
      align = "c",
      booktabs = TRUE)
```

```{r, comment=NA}
combined_data <- combined_data %>%
  rename(
    Номер_муниципального_района = "Содержание",
    Муниципальный_район = "X2",    
    Код_ОКТМО = "X3",
    Налогооблагаемые_доходы = "X4",
    Социальные_выплаты = "X5",
    Объем_соц_выплат_населению = "X6",
    Объем_соц_выплат_на_1_жителя = "X7",
    Год = "Year")


combined_data <- combined_data %>%
  filter(nchar(as.character(Код_ОКТМО)) >= 3)
```

Теперь находим первый код ОКТМО для каждого муниципального района (в случае если код не менялся, первый код ОКТМО будет и последним). Заменяем все последующие коды на первый, присвоив его соответствующему району. Теперь можно строить ряды.
```{r}
first_oktmo <- combined_data %>%
  group_by(Муниципальный_район) %>%
  summarize(Первый_код_ОКТМО = first(unique(Код_ОКТМО))) %>%
  ungroup()

combined_data <- combined_data %>%
  left_join(first_oktmo, by = "Муниципальный_район") %>%
  mutate(Код_ОКТМО = Первый_код_ОКТМО) %>%
  select(-Первый_код_ОКТМО) 
```

### Построение рядов 
#### Задача 2
<i><b>С помощью версионного справочника построить ряды об объеме социальных выплат на территориях муниципальных образований в 2018-2023 годах с учетом изменений их типов, названий, кодов и территориального состава:<br>

- если менялся тип, название и код, но территориальный состав оставался постоянным, то муниципальному образованию должен быть присвоен актуальный действующий код ОКТМО и построен непрерывный ряд значений показателя для соответствующей территории;<br>
- если изменился территориальный состав, то ряд может прерываться.</i></b><br>

Добавим в датафрейм новый столбец с общими доходами, сложив налогооблагаемые доходы с социальными выплатами.
```{r, comment=NA, warning=FALSE}
combined_data <- combined_data %>%
  filter(!is.na(Налогооблагаемые_доходы), !is.na(Социальные_выплаты))

combined_data <- combined_data %>%
  mutate(
    Налогооблагаемые_доходы = as.numeric(Налогооблагаемые_доходы),
    Социальные_выплаты = as.numeric(Социальные_выплаты)
  )

combined_data <- combined_data %>%
  mutate(Общие_доходы = Налогооблагаемые_доходы + Социальные_выплаты)
```

```{r, comment=NA, warning=FALSE}
summary_stats <- summary(combined_data$Общие_доходы)

summary_stats_df <- data.frame(
  Статистика = names(summary_stats),
  Значение = as.vector(summary_stats)
)

kable(summary_stats_df, caption = "Общие доходы: описательные статистики")
```

Выведем график для общих доходов по годам.
```{r, comment=NA, warning=FALSE}
total_income_by_year <- combined_data %>%
  group_by(Год) %>%
  summarise(Общие_доходы = sum(Общие_доходы, na.rm = TRUE))

format_billions <- function(x) {
  paste0(x / 1e9, " млрд р.")
}

ggplot(total_income_by_year, aes(x = Год, y = Общие_доходы)) +
  geom_line() +
  geom_point() +
  labs(title = "Общие доходы по годам",
       x = "Год",
       y = "Общие доходы") +
  scale_y_continuous(labels = format_billions) 
```

### Анализ и визуализация
#### Задача 3
<i><b>Проанализировать, как изменилась доля социальных выплат в структуре
доходов населения муниципальных образований в 2023 году
относительно 2018 года и предложить три типа визуализации.
Предположить, чем могут объясняться выявленные паттерны.</i></b><br>

Выведем график динамики долей налогооблагаемых доходов и социальных выплат.
```{r, comment=NA, warning=FALSE}
income_share <- combined_data %>%
  group_by(Год) %>%
  summarise(
    `Доля налогооблагаемых доходов` = sum(Налогооблагаемые_доходы, na.rm = TRUE) / sum(Общие_доходы, na.rm = TRUE),
    `Доля социальных выплат` = sum(Социальные_выплаты, na.rm = TRUE) / sum(Общие_доходы, na.rm = TRUE)
  )

income_share_long <- income_share %>%
  tidyr::pivot_longer(cols = c(`Доля налогооблагаемых доходов`, `Доля социальных выплат`),
                      names_to = "Тип_дохода",
                      values_to = "Доля")

ggplot(income_share_long, aes(x = Год, y = Доля, color = Тип_дохода)) +
  geom_line() +
  geom_point() +
  labs(title = "Доля налогооблагаемых доходов и социальных выплат по годам",
       x = "Год",
       y = "Доля",
       color = "Тип дохода")
```


2 вариант визуализации -- столбчатая диаграмма динамики долей налогооблагаемых доходов и социальных выплат.<br>
```{r, comment=NA, warning=FALSE}
ggplot(income_share_long, aes(x = Год, y = Доля, fill = Тип_дохода)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Сравнение долей соц. выплат и налогооблагаемых доходов в 2018 и 2023", x = "Год", y = "Доля",
       color = "Тип дохода") +
  scale_fill_manual(values = c("Доля налогооблагаемых доходов" = "skyblue", "Доля социальных выплат" = "salmon"))
```


3 вариант визуализации -- тепловая карта динамики долей налогооблагаемых доходов и социальных выплат.<br>
Примечание: это не лучший вариант визуализации, тут следовало бы еще обработать данные, чтобы было более читаемо и понятно. 
```{r, comment=NA, warning=FALSE}
combined_data <- combined_data %>%
  mutate(Регион = as.character(as.numeric(substr(Код_ОКТМО, 1, 2))))

municipality_share <- combined_data %>%
  filter(Год %in% c(2018, 2023)) %>%
  group_by(Год, Регион) %>%
  summarise(
    Доля_социальных_выплат = sum(Социальные_выплаты, na.rm = TRUE) / sum(Общие_доходы, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(Группа = as.numeric(Регион) %/% 10 + 1)

plots <- list()

for (i in 1:10) {
  p <- ggplot(filter(municipality_share, Группа == i), aes(x = Год, y = Регион, fill = Доля_социальных_выплат)) +
    geom_tile(color = "white") +
    labs(title = paste("Тепловая карта доли социальных выплат, Группа", i), 
         x = "Год", y = "Регион", fill = "Доля социальных выплат") +
    scale_fill_gradient(low = "lightyellow", high = "red") +
    scale_x_continuous(breaks = seq(min(municipality_share$Год), max(municipality_share$Год), by = 1))
  
  plots[[i]] <- p
}

for (i in 1:10) {
  print(plots[[i]])
}
```

### Дизайн исследования
#### Задача 4
<b><i>Кратко описать гипотетический дизайн исследования с оценкой влияния реализации инвестиционных проектов в муниципальных образованиях на рост налогооблагаемых денежных доходов населения.</i></b>

<b>Цель исследования:<br></b>
Оценить влияние реализации инвестиционных проектов на рост налогооблагаемых денежных доходов населения муниципальных образований в период 2018-2023 годов.<br>

<b>Содержательная гипотеза: <br></b>
Инвестиционные проекты способствуют увеличению налогооблагаемых доходов населения за счет роста занятости, доходов от предприятий и улучшения инфраструктуры.<br>

<b>Метод:<br></b>
Difference-in-Differences, DiD: Сравнить изменения доходов в муниципалитетах с инвестиционными проектами и без них, учитывая изменения до и после внедрения проекта. Регрессионный анализ с фиксированными эффектами: Учесть специфику муниципалитетов (численность населения, уровень безработицы и т.д.), которая может влиять на уровень доходов.<br>


### Комментарии к дизайну 
#### Задача 5
<b><i>Объяснить как дизайн исследования будет зависеть от механизма имплементации проектов (способ отбора муниципалитетов для участия в программе, учет характеристик муниципальных образований при отборе, масштаб инвестиций, количество муниципалитетов с инвестиционными проектами и т.п.).</i></b>

Механизм имплементации проектов напрямую влияет на выбор методик оценки и интерпретацию результатов. Ниже рассмотрим конкретные аспекты влияния.<br>

1. Отбор муниципалитетов<br>
Если отбор случайный, это упрощает использование методов, таких как разностный метод (DiD), минимизируя влияние сторонних факторов. При целенаправленном отборе (например, по уровню доходов) потребуется контролировать эти факторы, например, с помощью моделей с фиксированными эффектами.<br>

2. Характеристики муниципалитетов<br>
Если отбор учитывает демографические или экономические параметры, важно включить их в модель для снижения искажений. Например, более развитая инфраструктура муниципалитетов может повлиять на исходы, поэтому важно контролировать эти характеристики.<br>

3. Масштаб инвестиций<br>
При значительных различиях в объеме инвестиций их следует включить в модель как предиктор. Это позволит оценить, как рост доходов населения связан с масштабом вложений и выявить оптимальные уровни финансирования.<br>

4. Количество муниципалитетов<br>
Если охват велик, это повышает статистическую надежность. При малом охвате целесообразно использовать методы подбора контрольных групп (matching), чтобы уменьшить искажения.<br>

5. Направление проектов<br>
Разные виды проектов (инфраструктурные, социальные) могут по-разному влиять на доходы. Учёт типа и длительности проектов поможет разделить краткосрочные и долгосрочные эффекты, например, через панельные модели.<br>